<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Call Center Dashboard</title>
    <style>
        /* General Styles & Dark Theme */
        body {
            background-color: #121212;
            color: #E0E0E0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        /* Dashboard Layout */
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #FFFFFF;
            margin-bottom: 40px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* Agent Status Section */
        .status-section {
            flex: 1;
            min-width: 280px;
        }
        
        h2 {
            color: #BBBBBB;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
            margin-top: 0;
        }

        .status-card {
            background-color: #1E1E1E;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .status-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1em;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-dot.green { background-color: #2ECC71; }
        .status-dot.red { background-color: #E74C3C; }

        .status-count {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFFFFF;
        }

        /* Call Logs Section */
        .logs-section {
            flex: 3;
            min-width: 600px;
        }

        .table-container {
            background-color: #1E1E1E;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
        }

        thead {
            background-color: #333;
            color: #FFFFFF;
        }

        tbody tr {
            border-bottom: 1px solid #333;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody tr:nth-child(even) {
            background-color: #252525;
        }

        td {
            color: #CCCCCC;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <h1>AI Call Center Dashboard</h1>
        
        <div class="main-content">
            <!-- Section 1: Agent Status (Simulated) -->
            <div class="status-section">
                <h2>Live Agent Status</h2>
                <div class="status-card">
                    <div class="status-info">
                        <div class="status-dot green"></div>
                        <span>Agents Available</span>
                    </div>
                    <span class="status-count">3</span>
                </div>
                <div class="status-card">
                    <div class="status-info">
                        <div class="status-dot red"></div>
                        <span>Agents Busy</span>
                    </div>
                    <span class="status-count">1</span>
                </div>
            </div>

            <!-- Section 2: Call Logs (Live Data) -->
            <div class="logs-section">
                <h2>Recent Call Logs</h2>
                <div class="table-container">
                    <table id="call-logs-table">
                        <thead>
                            <tr>
                                <th>Call SID</th>
                                <th>Question Asked</th>
                                <th>User Response</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- This row will be shown when there are no logs -->
                            <tr id="waiting-message">
                                <td colspan="4" style="text-align: center; padding: 40px 0; color: #888;">Waiting for calls...</td>
                            </tr>
                            <!-- Log data will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Configuration ===
        // IMPORTANT: Replace this with your public ngrok URL from Step 3
        const serverUrl = 'https://<YOUR_NGROK_URL>.ngrok.io';

        // === DOM Elements ===
        const logsTableBody = document.querySelector('#call-logs-table tbody');
        const waitingMessageRow = document.querySelector('#waiting-message');

        /**
         * Fetches logs from the server and updates the table.
         */
        async function fetchLogs() {
            try {
                const response = await fetch(`${serverUrl}/logs`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const logs = await response.json();

                // Clear only the data rows, keeping the waiting message template
                logsTableBody.innerHTML = '';
                logsTableBody.appendChild(waitingMessageRow); // Re-add it in case it was removed

                if (logs.length > 0) {
                    waitingMessageRow.style.display = 'none'; // Hide the "Waiting..." message

                    // Populate table with new logs, newest first
                    logs.slice().reverse().forEach(log => {
                        const row = document.createElement('tr');
                        
                        // Sanitize and format data for display
                        const shortSid = '...' + (log.callSid || 'N/A').slice(-8);
                        const question = log.question || 'N/A';
                        const userResponse = log.response || 'No speech detected';
                        const timestamp = new Date(log.timestamp).toLocaleTimeString();

                        row.innerHTML = `
                            <td>${shortSid}</td>
                            <td>${question}</td>
                            <td>${userResponse}</td>
                            <td>${timestamp}</td>
                        `;
                        logsTableBody.appendChild(row);
                    });
                } else {
                    waitingMessageRow.style.display = 'table-row'; // Show the "Waiting..." message
                }
            } catch (error) {
                console.error('Failed to fetch logs:', error);
                waitingMessageRow.style.display = 'table-row';
                waitingMessageRow.querySelector('td').textContent = 'Error connecting to server. Is it running?';
            }
        }

        // Fetch logs every 3 seconds to keep the dashboard updated
        setInterval(fetchLogs, 3000);

        // Fetch logs immediately when the page loads
        document.addEventListener('DOMContentLoaded', fetchLogs);

    </script>
</body>
</html>